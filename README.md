# git-back
Программа для использования *Яндекс.Диск* или *Яндекс.Облако* как хранилище репозиториев.

# Установка
Для установки запустить скрипт из папки `scripts`:
- `install.bat` для ОС Windows (для корректной работы после этого требуется перезагрузить компьютер)
- `install.sh` для ОС Linux (необязательно под root'ом. Создаст локальную папку `~/.local/local/bin`, если ее нет)

Если перед установкой не был установлен Node.js (либо же его нет в PATH), то модули для программы установлены не будут. После установки Node.js неободимо повторить установку, либо же можно установить отдельно модули, выполнив команду `npm i` из папки с программой, или запустив скрипт из папки `scripts`:
- `install-modules.bat` для ОС Windows
- `install-modules.sh` для ОС Linux

# Запуск
Перед запуском необходимо убедиться, что в системе установлен Node.js и в папке с программой установлены необходимые модули (см. Установка). Запуск:
```
git-back <command> [<action> [<arg1> [<arg2> [<arg3>]]]]
```
### Яндекс.Диск
Для связи с *Яндекс.Диск* необходим идентификатор приложения и токен. 
1. Идентификатор приложения. Состоит из ID приложения и пароля. Он должен располагаться в файле `credentials/yandexDiskAppID.json`. Пример в файле `credentials/yandexDiskAppID.sample`. Для получения необходимо его зарегестрировать на [странице Яндекс.OAuth](https://oauth.yandex.ru/). В разделе __Платформы__ выбрать __Веб-сервисы__ и в поле *Callback URI* вставить __`git-back://token`__. Также необходимо предоставить доступ к `Яндекс.Диск REST API` установкой всех галочек в соответствующем разделе.
2. Токен. Состоит из токена для авторизации, токена для обновления, время жизни и дата получения. Должен располагаться в файле `credentials/yandexDiskToken.json`. Пример в файле `credentials/yandexDiskToken.sample`. Если его нет, программа попытается его получить, направив пользователя на страницу Яндекса, где он должен предоставить приложению доступ к его аккаунту. За неделю до окончания времени жизни токена приложение попытается его обновить с помощью токена для обновления. Если время жизни истекло, то программа запросит новый токен.
### Яндекс.Облако
В конце 2019 года Яндекс ограничил скорость загрузки файлов на *Яндек.Диск* для всех сторонних приложений до мизерных значений, репозиторий размером 20МБ мог отправляться по 5 минут. Поэтому дополнительно добавлена поддержка *Яндекс.Облако*.
Для связи с *Яндекс.Облако* необходимо: 
 - в [консоли управления](https://console.cloud.yandex.ru/) создать платежный аккаунт;
 - во вкладке __Object Storage__ необходимо создать бакет с каким-то именем;
 - создать сервисный аккаунт (имя любое); на странице обзора этого аккаунта создать статический ключ доступа (__Создать новый ключ/Создать статический ключ__), идентификатор и секретный ключ записать (если этого не сделать, то после закрытия страницы доступ к нему будет потерян, и придется создавать новый).

После выполнения всех этих действий необходимо записать имя бакета, идентификатор ключа и сам ключ в файл `yandexCloudAccount.json`, пример в файле `yandexCloudAccount.sample`.
Стоит учесть, что *Яндекс.Облако* - платный сервис, за хранение данных и запросы к ним необходимо будет платить. Цены можно узнать на странице [тарифов](https://cloud.yandex.ru/prices).
### Шифрование
Перед отправкой в хранилище (*Яндекс.Диск* или *Яндекс.Облако*) репозиторий добавляется в архив, после чего его можно при желании зашифровать. Ключ для шифрования должен быть один и тот же на всех компьютерах, иначе репозиторий, отправленный с одного компьютера, не сможет открыться на другом. Ключ хранится в файле `repoCrypt.json`, пример в `repoCrypt.sample` (до версии v5.0-beta хранился в `appID.json`). При его отсутствии новый ключ будет сгененрирован программой самостоятельно и сохранен в файл `repoCrypt.json`.

# Команды
Для некоторых комманд необходимо на первом месте указать параметр `disk` или `cloud`, в зависимости от того, куда необходимо обращаться (в *Яндекс.Диск* или *Яндекс.Облако* соответсвенно).
- `init` - Инициализация пустого git-репозитория.
- `(disk|cloud) push [repo] [nocrypt]` - Отправка данных на сервер. Если указан параметр `repo`, то без взятия сделанных изменений из текущего репозитория. Если указан параметр `nocrypt`, то на сервер отправятся незашифрованные данные.
- `(disk|cloud) pull [repo] [nocrypt]` - Получение данных с сервера. Если указан параметр `repo`, то без внесения изменений в текущий репозиторий. Если указан параметр `nocrypt`, то после получения данные не расшифруются.
- `(disk|cloud) list` - Вывести список репозиториев на сервере
- `(disk|cloud) clone <project> <repo> [nocrypt]` - Загрузить и клонировать репозиторий `<repo>` из проекта `<project>` с сервера. Если указан параметр `nocrypt`, то после получения данные не расшифруются.
- `clear` - Удалить локальную копию репозитория
- `clear-all` - Удалить локальные копии всех репозиториев
- `url <url>` - Обработка URL схемы `git-back://`